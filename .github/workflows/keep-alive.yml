name: Keep Streamlit App Alive

on:
  schedule:
    # PoniedziaÅ‚ek-PiÄ…tek o 5:30 UTC (Polska zima: 6:30, Polska lato: 7:30)
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  ping-app:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Secret
        run: |
          if [ -z "${{ secrets.STREAMLIT_APP_URL }}" ]; then
            echo "âŒ ERROR: STREAMLIT_APP_URL secret is not configured!"
            echo "Please add it in Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          else
            echo "âœ… Secret STREAMLIT_APP_URL is configured"
          fi
          
      - name: Ping Health Check Endpoint
        run: |
          # Dodaj parametr health=check do URL
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          HEALTH_URL="${APP_URL%/}/?health=check"
          
          echo "ðŸš€ Streamlit Keep-Alive Service"
          echo "================================"
          echo "â° Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Target: $HEALTH_URL"
          echo ""
          
          # Pierwszy ping - budzenie aplikacji (moÅ¼e trwaÄ‡ dÅ‚ugo)
          echo "ðŸ“¡ First ping (wake-up call)..."
          echo "   Timeout: 120 seconds (app may be sleeping)"
          echo ""
          
          RESPONSE1=$(curl -s -w "\n%{http_code}|%{time_total}" --max-time 120 "$HEALTH_URL" 2>&1) || true
          
          BODY1=$(echo "$RESPONSE1" | head -n -1)
          STATUS1=$(echo "$RESPONSE1" | tail -1 | cut -d'|' -f1)
          TIME1=$(echo "$RESPONSE1" | tail -1 | cut -d'|' -f2)
          
          echo "   Response: $BODY1"
          echo "   Status: $STATUS1"
          echo "   Time: ${TIME1}s"
          echo ""
          
          # Czekaj 15 sekund
          echo "â³ Waiting 15 seconds for full initialization..."
          sleep 15
          echo ""
          
          # Drugi ping - weryfikacja
          echo "ðŸ“¡ Second ping (verification)..."
          
          RESPONSE2=$(curl -s -w "\n%{http_code}|%{time_total}" --max-time 30 "$HEALTH_URL" 2>&1) || true
          
          BODY2=$(echo "$RESPONSE2" | head -n -1)
          STATUS2=$(echo "$RESPONSE2" | tail -1 | cut -d'|' -f1)
          TIME2=$(echo "$RESPONSE2" | tail -1 | cut -d'|' -f2)
          
          echo "   Response: $BODY2"
          echo "   Status: $STATUS2"
          echo "   Time: ${TIME2}s"
          echo ""
          
          # Ocena wyniku
          echo "================================"
          if [ "$STATUS2" = "200" ] && [ "$BODY2" = "OK" ]; then
            echo "âœ… SUCCESS! App is alive and responding correctly!"
            echo "RESULT=success" >> $GITHUB_ENV
          elif [ "$STATUS2" = "200" ]; then
            echo "âœ… SUCCESS! App is responding (Status 200)"
            echo "RESULT=success" >> $GITHUB_ENV
          elif [ "$STATUS1" = "200" ]; then
            echo "âš ï¸ PARTIAL SUCCESS - First ping worked, second had issues"
            echo "RESULT=partial" >> $GITHUB_ENV
          else
            echo "âŒ WARNING: App may need manual check"
            echo "   Status codes: $STATUS1 â†’ $STATUS2"
            echo "RESULT=failed" >> $GITHUB_ENV
          fi
          
      - name: Create Summary Report
        if: always()
        run: |
          echo "## ðŸŒŸ Streamlit Keep-Alive Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| â° Time | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Endpoint | \`?health=check\` |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$RESULT" = "success" ]; then
            echo "| âœ… Status | **Alive & Healthy** |" >> $GITHUB_STEP_SUMMARY
          elif [ "$RESULT" = "partial" ]; then
            echo "| âš ï¸ Status | **Partial Success** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Status | **Needs Attention** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Triggered by: ${{ github.event_name }}*" >> $GITHUB_STEP_SUMMARY