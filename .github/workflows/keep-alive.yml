name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  ping-app:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Streamlit App
        id: ping
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          HEALTH_URL="${APP_URL}?health=check"
          
          echo "ðŸš€ Streamlit Keep-Alive"
          echo "â° $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Ping 1: Wake up
          echo "ðŸ“¡ Ping 1: Wake up..."
          START=$(date +%s)
          
          RESPONSE1=$(curl -sL --max-time 180 "$HEALTH_URL" 2>&1)
          
          END=$(date +%s)
          TIME1=$((END - START))
          
          echo "   Response: $RESPONSE1"
          echo "   Time: ${TIME1}s"
          
          echo "PING1_RESPONSE=$RESPONSE1" >> $GITHUB_OUTPUT
          echo "PING1_TIME=$TIME1" >> $GITHUB_OUTPUT
          
          # Wait
          echo ""
          echo "â³ Waiting 10 seconds..."
          sleep 10
          
          # Ping 2: Verify
          echo ""
          echo "ðŸ“¡ Ping 2: Verify..."
          
          RESPONSE2=$(curl -sL --max-time 30 "$HEALTH_URL" 2>&1)
          
          echo "   Response: $RESPONSE2"
          
          echo "PING2_RESPONSE=$RESPONSE2" >> $GITHUB_OUTPUT
          
          # Result
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "$RESPONSE2" = "OK" ]; then
            echo "âœ… SUCCESS! App is alive!"
            echo "RESULT=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Unexpected response: $RESPONSE2"
            echo "RESULT=check" >> $GITHUB_OUTPUT
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŒŸ Streamlit Keep-Alive Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.ping.outputs.RESULT }}" = "success" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Status: CHECK NEEDED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ping | Response | Time |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Wake | \`${{ steps.ping.outputs.PING1_RESPONSE }}\` | ${{ steps.ping.outputs.PING1_TIME }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Verify | \`${{ steps.ping.outputs.PING2_RESPONSE }}\` | - |" >> $GITHUB_STEP_SUMMARY